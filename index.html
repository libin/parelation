<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Parelation by meskyanichi</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Parelation</h1>
        <p></p>

        <p class="view"><a href="https://github.com/meskyanichi/parelation">View the Project on GitHub <small>meskyanichi/parelation</small></a></p>


        <ul>
          <li><a href="https://github.com/meskyanichi/parelation/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/meskyanichi/parelation/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/meskyanichi/parelation">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="parelation" class="anchor" href="#parelation"><span class="octicon octicon-link"></span></a>Parelation</h1>

<p><a href="https://codeclimate.com/github/meskyanichi/parelation"><img src="https://codeclimate.com/github/meskyanichi/parelation.png" alt="Code Climate"></a>
<a href="https://travis-ci.org/meskyanichi/parelation"><img src="https://travis-ci.org/meskyanichi/parelation.svg" alt="Build Status"></a></p>

<p>Parelation, for Rails/ActiveRecord 4.1.0+, allows you to query your ActiveRecord-mapped database easily, securely and quite flexibly using simple GET requests. It's used in your controller layer where it uses HTTP GET parameters to build on the ActiveRecord::Relation chain. This provides the client-side with the out-of-the-box flexibility to perform fairly dynamic queries without having to write boilerplate on the server.</p>

<p><em>Note: This library is being developed in parallel with <a href="http://hirefire.io">HireFire</a> and the public api is should be considered unstable for the time being. This notice will be removed once the api stabalizes.</em></p>

<h3>
<a name="compatibility" class="anchor" href="#compatibility"><span class="octicon octicon-link"></span></a>Compatibility</h3>

<ul>
<li>Rails/ActiveRecord 4.1.0+</li>
<li>Ruby (MRI) 2.0+</li>
<li>Ruby (RBX) 2.2+</li>
</ul><h3>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h3>

<p>Compile and install the gem from source.</p>

<div class="highlight highlight-rb"><pre><span class="n">gem</span> <span class="s2">"parelation"</span><span class="p">,</span> <span class="ss">github</span><span class="p">:</span> <span class="s2">"meskyanichi/parelation"</span>
</pre></div>

<p><em>This library won't be hosted on RubyGems.org until it's been tested more in development.</em></p>

<h3>
<a name="example" class="anchor" href="#example"><span class="octicon octicon-link"></span></a>Example</h3>

<p>Here's an example to get an idea of how it works. We'll fetch the <code>50</code> most recently created and <code>open</code> tickets, and we only want their <code>id</code>, <code>name</code> and <code>message</code> attributes.</p>

<div class="highlight highlight-js"><pre><span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"select[]"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">,</span> <span class="s2">"message"</span><span class="p">],</span>
  <span class="s2">"where[state]"</span><span class="o">:</span> <span class="s2">"open"</span><span class="p">,</span>
  <span class="s2">"order"</span><span class="o">:</span> <span class="s2">"created_at:desc"</span><span class="p">,</span>
  <span class="s2">"limit"</span><span class="o">:</span> <span class="s2">"50"</span>
<span class="p">}</span>

<span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"https://api.ticket.app/tickets"</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tickets</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Just fetched the 50 most recent and open tickets."</span><span class="p">)</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">tickets</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ticket</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Ticket "</span> <span class="o">+</span> <span class="nx">ticket</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">" loaded!"</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
</pre></div>

<p>Simply include <code>Parelation::Helpers</code> and use the <code>parelate</code> method. This will ensure that the provided parameters are converted and applied to the <code>Ticket.all</code> criteria chain.</p>

<div class="highlight highlight-rb"><pre><span class="k">class</span> <span class="nc">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">TicketsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Parelation</span><span class="o">::</span><span class="no">Helpers</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="n">parelate</span><span class="p">(</span><span class="no">Ticket</span><span class="o">.</span><span class="n">all</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>You can also scope results to the <code>current_user</code>:</p>

<div class="highlight highlight-rb"><pre><span class="k">class</span> <span class="nc">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">TicketsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Parelation</span><span class="o">::</span><span class="no">Helpers</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="n">parelate</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">tickets</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Using the same JavaScript, this'll now fetch the 50 most recent open tickets scoped to the <code>current_user</code>.</p>

<h3>
<a name="parameter-list-reference" class="anchor" href="#parameter-list-reference"><span class="octicon octicon-link"></span></a>Parameter List (Reference)</h3>

<p>Here follows a list of all possible query syntaxes. We'll assume we have a Ticket model to query on.</p>

<h4>
<a name="select" class="anchor" href="#select"><span class="octicon octicon-link"></span></a>Select</h4>

<pre><code>/tickets?select[]=id&amp;select[]=name&amp;select[]=message
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:message</span><span class="p">)</span>
</pre></div>

<h4>
<a name="where" class="anchor" href="#where"><span class="octicon octicon-link"></span></a>Where</h4>

<pre><code>/tickets?where[state]=open
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">state</span><span class="p">:</span> <span class="s2">"open"</span><span class="p">)</span>
</pre></div>

<p>You can also specify multiple multiple conditions:</p>

<pre><code>/tickets?where[state][]=open&amp;where[state][]=pending
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">state</span><span class="p">:</span> <span class="o">[</span><span class="s2">"open"</span><span class="p">,</span> <span class="s2">"pending"</span><span class="o">]</span><span class="p">)</span>
</pre></div>

<h4>
<a name="where-directional" class="anchor" href="#where-directional"><span class="octicon octicon-link"></span></a>Where (directional)</h4>

<ul>
<li>
<code>where_gt</code> (greater than <code>&gt;</code>)</li>
<li>
<code>where_gte</code> (greater than or equal to <code>&gt;=</code>)</li>
<li>
<code>where_lt</code> (less than <code>&lt;</code>)</li>
<li>
<code>where_lte</code> (less than or equal to <code>&lt;=</code>)</li>
</ul><pre><code>/tickets?where_gt[created_at]=2014-01-01T00:00:00Z
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"'tickets'.'created_at' &gt; '2014-01-01 00:00:00.000000'"</span><span class="p">)</span>
</pre></div>

<p>You can also specify multiple conditions:</p>

<pre><code>/tickets?where_gt[created_at]=2014-01-01T00:00:00Z&amp;where_gt[updated_at]=2014-01-01T00:00:00Z
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span>
  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"'tickets'.'created_at' &gt; '2014-01-01 00:00:00.000000'"</span><span class="p">)</span>
  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"'tickets'.'updated_at' &gt; '2014-01-01 00:00:00.000000'"</span><span class="p">)</span>
</pre></div>

<h4>
<a name="query" class="anchor" href="#query"><span class="octicon octicon-link"></span></a>Query</h4>

<pre><code>/tickets?query[memory leak]=name
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"'tickets'.'name' LIKE '%memory leak%'"</span><span class="p">)</span>
</pre></div>

<p>You can also specify multiple columns to scan:</p>

<pre><code>/tickets?query[memory leak]=name&amp;query[memory leak]=message
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"(</span>
<span class="s2">  'tickets'.'name' LIKE '%memory leak%' OR</span>
<span class="s2">  'tickets'.'message' LIKE '%memory leak%'</span>
<span class="s2">)"</span><span class="p">)</span>
</pre></div>

<h4>
<a name="order" class="anchor" href="#order"><span class="octicon octicon-link"></span></a>Order</h4>

<pre><code>/tickets?order=created_at:desc
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">created_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span>
</pre></div>

<p>You can also specify multiple order-operations:</p>

<pre><code>/tickets?order[]=created_at:desc&amp;order[]=name:asc
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">created_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="ss">:asc</span><span class="p">)</span>
</pre></div>

<h4>
<a name="limit" class="anchor" href="#limit"><span class="octicon octicon-link"></span></a>Limit</h4>

<pre><code>/tickets?limit=50
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>

<h4>
<a name="offset" class="anchor" href="#offset"><span class="octicon octicon-link"></span></a>Offset</h4>

<pre><code>/tickets?offset=25
</code></pre>

<p>Translates to:</p>

<div class="highlight highlight-rb"><pre><span class="no">Ticket</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
</pre></div>

<h3>
<a name="error-handling" class="anchor" href="#error-handling"><span class="octicon octicon-link"></span></a>Error Handling</h3>

<p>When invalid parameters were sent, you can rescue the exception and return a message to the client.</p>

<div class="highlight highlight-rb"><pre><span class="k">class</span> <span class="nc">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">TicketsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Parelation</span><span class="o">::</span><span class="no">Helpers</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="n">parelate</span><span class="p">(</span><span class="no">Ticket</span><span class="o">.</span><span class="n">all</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">Parelation</span><span class="o">::</span><span class="no">Errors</span><span class="o">::</span><span class="no">Parameter</span> <span class="o">=&gt;</span> <span class="n">error</span>
    <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="p">{</span> <span class="ss">error</span><span class="p">:</span> <span class="n">error</span> <span class="p">},</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:bad_request</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>This will tell client developers what parameter failed in the HTTP response. This exception generally occurs when there is a typo in the URL's parameters. Knowing which parameter failed (described in <code>error</code>) helps narrowing down the issue.</p>

<h3>
<a name="contributing" class="anchor" href="#contributing"><span class="octicon octicon-link"></span></a>Contributing</h3>

<p>Contributions are welcome, but please conform to these requirements:</p>

<ul>
<li>Ruby (MRI) 2.0+ <a href="https://travis-ci.org/meskyanichi/parelation">TravisCI</a>
</li>
<li>Ruby (RBX) 2.2+ <a href="https://travis-ci.org/meskyanichi/parelation">TravisCI</a>
</li>
<li>ActiveRecord 4.1.0+</li>
<li>100% Spec Coverage

<ul>
<li>Generated by <code>$ rspec spec</code> (run entire suite)</li>
</ul>
</li>
<li>4.0 (max) <a href="https://codeclimate.com/github/meskyanichi/parelation">Code Climate</a> Score

<ul>
<li>Use <code>$ rubycritic lib</code> to generate score / tips locally</li>
<li>No code smells</li>
<li>No duplication</li>
</ul>
</li>
</ul><h3>
<a name="author--license" class="anchor" href="#author--license"><span class="octicon octicon-link"></span></a>Author / License</h3>

<p>Copyright (c) 2014 Michael van Rooijen ( <a href="https://twitter.com/meskyanichi">@meskyanichi</a> )<br>
Released under the MIT <a href="https://github.com/meskyanichi/parelation/blob/master/LICENSE">License</a>.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/meskyanichi">meskyanichi</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>